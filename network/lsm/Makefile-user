# Common Makefile parts for BPF-building with libbpf

USER_TARGETS := test_lsm

CC ?= gcc


USER_C := ${USER_TARGETS:=.c}
USER_OBJ := ${USER_C:.c=.o}


#Linux source code folder
SRC_DIR ?= /usr/src/linux-source-5.11.0/linux-source-5.11.0

# Expect this is defined by including Makefile, but define if not
LIBBPF_DIR ?= ../libbpf/src
OBJECT_LIBBPF = $(LIBBPF_DIR)/libbpf.a

LDFLAGS ?= -L$(LIBBPF_DIR)/

BPF_GCCFLAGS ?= -I$(SRC_DIR)/tools/testing/selftests/bpf/
BPF_GCCFLAGS += -I$(SRC_DIR)/usr/include/
BPF_GCCFLAGS += -I$(SRC_DIR)/tools/lib/
BPF_GCCFLAGS += -I$(SRC_DIR)/tools/include/
BPF_GCCFLAGS += -I$(SRC_DIR)/tools/perf/
BPF_GCCFLAGS += -I../libbpf/src/


LIBS = -l:libbpf.a -lelf -lz 


all: llvm-check $(OBJECT_LIBBPF) $(USER_OBJ) $(USER_TARGETS)

.PHONY: clean $(CLANG) $(LLC)

clean:
	rm -rf $(LIBBPF_DIR)/build
	$(MAKE) -C $(LIBBPF_DIR) clean
	rm -f $(USER_TARGETS) $(USER_OBJ)
	rm -f *.ll
	rm -f *.o
	rm -f fds

llvm-check: $(CLANG) $(LLC)
	@for TOOL in $^ ; do \
           if [ ! $$(command -v $${TOOL} 2>/dev/null) ]; then \
              echo "*** ERROR: Cannot find tool $${TOOL}" ;\
              exit 1; \
           else true; fi; \
        done

$(OBJECT_LIBBPF):
	@if [ ! -d $(LIBBPF_DIR) ]; then \
	  echo "Error: Need libbpf submodule"; \
	  echo "May need to run git submodule update --init"; \
	  exit 1; \
	else \
          cd $(LIBBPF_DIR) && $(MAKE) all OBJDIR=.; \
          mkdir -p build; $(MAKE) install_headers DESTDIR=build OBJDIR=.; \
        fi

#$(USER_OBJ): 
#	$(CC) -Wall -O2 -Wmissing-prototypes -Wstrict-prototypes $(BPF_GCCFLAGS)  \
#        -DHAVE_ATTR_TEST=0 \
#        -c -o ./test_lsm.o ./test_lsm.c
#
$(USER_OBJ):
	$(CC) -I. -g -rdynamic -Wall -O2 -DHAVE_GENHDR \
       	-I/usr/src/linux-source-5.11.0/linux-source-5.11.0/tools/testing/selftests/bpf \
	-I/usr/src/linux-source-5.11.0/linux-source-5.11.0/tools/testing/selftests/bpf/tools/include \
	-I/usr/src/linux-source-5.11.0/linux-source-5.11.0/include/generated \
	-I/usr/src/linux-source-5.11.0/linux-source-5.11.0/tools/lib \
        -I/usr/src/linux-source-5.11.0/linux-source-5.11.0/tools/include \ 
	-I/usr/src/linux-source-5.11.0/linux-source-5.11.0/tools/include/uapi \
	-Dbpf_prog_load=bpf_prog_test_load -Dbpf_load_program=bpf_test_load_program \
	-c /usr/src/linux-source-5.11.0/linux-source-5.11.0/tools/testing/selftests/bpf/prog_tests/test_lsm.c \
	-lcap -lelf -lz -lrt -lpthread -o test_lsm.test.o

$(USER_TARGETS):
	$(CC) -Wp,-MD,-Wall -O2 -Wmissing-prototypes -Wstrict-prototypes $(BPF_GCCFLAGS)  \
        -DHAVE_ATTR_TEST=0 \
	-o ./lsm ./test_lsm.o ../libbpf/src/libbpf.a -lelf -lz

